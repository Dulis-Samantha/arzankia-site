<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<meta name="robots" content="noindex"/>
<title>Camidjo ‚Äî Chansons & Magasin</title>
<style>
  body{
    background:url("fond_artistes.png") center/cover fixed no-repeat;
    color:#fff8e6; font-family:Georgia,serif; text-align:center;
    margin:0; padding:2rem; min-height:100vh; box-sizing:border-box;
  }
  h1{ color:#f0d864; margin-bottom:1rem; }

  .bloc-contenu{
    max-width:800px; margin:auto; padding:2rem;
    background:rgba(0,0,0,.4); border-radius:15px;
  }
  .bloc-contenu h2{ color:#ffe066; margin:.2rem 0 .5rem; }
  .bloc-contenu p{ font-size:1.1rem; line-height:1.7; }

  .Artistes-image{
    width:100%; max-width:600px; border-radius:20px;
    box-shadow:0 0 25px rgba(255,255,255,.15); display:block; margin:2rem auto;
  }

  .chanson,.card{
    margin:1.2rem auto; max-width:720px; text-align:left;
    background:rgba(0,0,0,.38); border:1px solid rgba(255,255,255,.18);
    padding:1rem; border-radius:16px; backdrop-filter: blur(4px);
  }
  .chanson p{ margin:.2rem 0 .5rem; font-weight:600; }
  audio{ width:100%; margin-top:.4rem; }

  /* --- En-t√™te solde / message --- */
  .header-notes{
    max-width:1000px; margin:1.6rem auto; display:flex;
    flex-direction:column; gap:1rem; align-items:center;
  }
  .note-info{
    font-size:1.35rem; color:#ffe066; font-weight:700;
    text-shadow:0 0 10px rgba(255,223,100,.55), 0 0 22px rgba(255,223,100,.35);
    animation:glow 2.6s ease-in-out infinite alternate;
  }
  .note-info small{ display:block; margin-top:.25rem; font-weight:400; font-size:1rem; color:#fff8e6; opacity:.95; }
  @keyframes glow{
    from{ text-shadow:0 0 10px rgba(255,223,100,.5), 0 0 24px rgba(255,223,100,.3); transform:translateY(0); }
    to  { text-shadow:0 0 16px rgba(255,235,140,.9), 0 0 34px rgba(255,223,100,.8); transform:translateY(-1px); }
  }

  .wallet{
    display:flex; gap:.6rem; align-items:center; flex-wrap:wrap;
  }
  .badge-notes{
    display:inline-flex; align-items:center; gap:.5rem;
    padding:.45rem .85rem; border-radius:999px;
    background: linear-gradient(120deg,#ffef9f,#ffd76a,#ffb84d);
    color:#3b2d16; border:1px solid rgba(0,0,0,.25);
    box-shadow: 0 2px 10px rgba(0,0,0,.25), inset 0 1px 0 #fff8;
    font-variant-numeric: tabular-nums;
  }
  .btn{
    appearance:none; border:none; cursor:pointer;
    padding:.55rem .9rem; border-radius:12px; font-weight:600;
  }
  .btn-ghost{ background:transparent; color:#ffe066; border:1px dashed #ffe066; }
  .btn-ghost:hover{ background:rgba(255,224,102,.12); }
  .btn-buy{ background:#ffe066; color:#3b2d16; }
  .btn-buy[disabled]{ opacity:.6; cursor:not-allowed; }
  .price{ color:#ffe066; font-weight:700; }

  /* --- Grille boutique --- */
  .shop{
    max-width:1000px; margin:1.2rem auto; display:grid; gap:1rem;
    grid-template-columns:1fr;
  }
  @media(min-width:900px){ .shop{ grid-template-columns:1fr 1fr; } }

  .card h3{ margin:.2rem 0 .6rem; color:#ffe066; }
  .owned{ color:#9fe29f; font-weight:700; }
  .hint{ opacity:.9; font-size:.95rem; margin:.4rem 0 0; }

  /* --- Overlay notes plein √©cran --- */
  .zone-notes{
    position:fixed; inset:0; width:100%; height:100%; z-index:30;
    pointer-events:none; overflow:hidden;
  }
  .note{
    position:absolute; pointer-events:auto; width:clamp(26px,3.5vw,40px);
    aspect-ratio:1/1; cursor:pointer; transform-origin:center;
    animation:flotter var(--duree,10s) linear forwards, wiggle 2.4s ease-in-out infinite;
    filter:drop-shadow(0 6px 10px rgba(0,0,0,.45)); background:none; border:none; padding:0;
  }
  .note svg{ width:100%; height:100%; display:block; }
  .note.collected{ animation:pop .35s ease forwards; }

  @keyframes flotter{ from{ transform:translateY(0) rotate(-8deg); opacity:0; } 10%{opacity:1;} to{ transform:translateY(-120vh) rotate(8deg); opacity:0; } }
  @keyframes wiggle{ 0%,100%{ transform:translateY(0) rotate(-2deg);} 50%{ transform:translateY(-6px) rotate(2deg);} }
  @keyframes pop{ 0%{transform:scale(1);opacity:1;} 70%{transform:scale(1.6);opacity:1;filter:drop-shadow(0 12px 24px rgba(0,0,0,.5));} 100%{transform:scale(.6);opacity:0;} }

  .sr-only{ position:absolute!important; width:1px; height:1px; overflow:hidden; clip:rect(1px,1px,1px,1px); white-space:nowrap; }

  /* ===== Bulle magique (remplace alert) ===== */
  .magic-alert {
    position: fixed;
    top: 50%; left: 50%;
    transform: translate(-50%, -50%) scale(0.9);
    background: rgba(20, 10, 0, 0.85);
    color: #ffeb9b;
    border: 1px solid rgba(255, 215, 100, 0.6);
    border-radius: 18px;
    box-shadow: 0 0 25px rgba(255, 215, 100, 0.3);
    padding: 1.3rem 1.6rem;
    max-width: 320px; width: 80%;
    text-align: center;
    font-size: 1.05rem; line-height: 1.5;
    z-index: 9999; opacity: 0; transition: all 0.35s ease;
  }
  .magic-alert.show { opacity: 1; transform: translate(-50%, -50%) scale(1); }
  .magic-alert::before { content: "‚ú®"; display: block; font-size: 1.8rem; margin-bottom: .5rem; }
  .magic-alert button {
    margin-top: 1rem; background: #ffd76a; color: #3b2d16;
    border: none; border-radius: 10px; padding: .4rem 1rem; cursor: pointer; font-weight: 600;
    box-shadow: 0 0 8px rgba(255,215,100,.4);
  }
  .magic-alert button:hover { background: #ffef9f; }

  /* ===== Mobile fine-tuning (‚â§ 480px) ===== */
  @media (max-width: 480px){
    body{ padding: 1.2rem; }
    h1{ font-size: 1.6rem; line-height: 1.15; margin: 1rem 0 .6rem; }
    .bloc-contenu{ max-width: 100%; padding: 1.1rem 1rem; border-radius: 14px; }
    .bloc-contenu h2{ font-size: 1.35rem; margin-bottom: .3rem; }
    .bloc-contenu h3{ font-size: 1.05rem; letter-spacing: .02em; margin: .2rem 0 .4rem; }
    .bloc-contenu p { font-size: 1rem; line-height: 1.5; }
    .chanson{ max-width: 100%; padding: .8rem; margin: 1rem auto; border-radius: 12px; }
    .Artistes-image{ margin: 1.2rem auto; border-radius: 16px; }
    audio{ margin-top: .35rem; }
    .note-info{ font-size: 1.05rem; text-shadow: 0 0 8px rgba(255,223,100,.45); animation-duration: 3.2s; }
    .note-info small{ font-size: .9rem; }
    .badge-notes{ padding: .35rem .7rem; transform: scale(.97); }
    .reset-notes{ padding: .4rem .65rem; font-size: .95rem; }
    .shop{ grid-template-columns: 1fr !important; gap: .9rem; }
    .card{ max-width: 100%; padding: .9rem; border-radius: 14px; }
  }
  /* Option tablette */
  @media (max-width: 768px){
    h1{ font-size: 1.8rem; }
    .bloc-contenu p{ font-size: 1.05rem; }
  }
</style>
</head>
<body>
  <div class="bloc-contenu">
    <h2>Camidjo</h2>
    <h3>‚Äì Le Cr√©ateur ‚Äì</h3>
    <p>Camidjo est le r√™veur √† l‚Äôorigine de ce monde. Sa voix r√©sonne encore entre les murs peints de son imagination.</p>
  </div>

  <img class="Artistes-image" src="monde_Artiste.png" alt="Illustration du Monde des Artistes">

  <h1>üéµ Chansons de Camidjo</h1>

  <!-- Piste gratuite pour r√©colter des notes -->
  <div class="chanson">
    <p>üé∂ Pens√©e pour elle <span class="hint">(gratuite)</span></p>
    <audio controls crossorigin="anonymous" src="camidjo_pensee.mp3"></audio>
  </div>

  <!-- Solde + message -->
  <div class="header-notes" aria-live="polite">
    <div class="note-info">
      ‚ú® Ramasse les notes dor√©es ‚ú®
      <small>Ach√®te les chansons avec tes notes r√©colt√©es dans la page.</small>
    </div>
    <div class="wallet">
      <span class="badge-notes">Solde : <strong id="notesCount">0</strong> ‚úß</span>
      <button id="resetNotes" class="btn btn-ghost" type="button">R√©initialiser le solde & achats</button>
    </div>
  </div>

  <!-- Overlay des notes -->
  <div id="zoneNotes" class="zone-notes" aria-label="Zone de collecte des notes"></div>

  <!-- Boutique -->
  <section class="shop" id="shop"></section>

  <a href="8.monde_Artistes.html" class="btn btn-ghost" style="margin-top:1.2rem;">‚Üê Retour au Monde des Artistes</a>

<script>
/* =================== CONFIG BOUTIQUE =================== */
const STORAGE_NOTES = 'camidjo_notes_balance';
const STORAGE_OWNED = 'camidjo_owned_tracks';

const TRACKS = [
  { id:'facon',    title:'Fa√ßon de faire',     price:150, src:'camidjo_facon_de_faire.mp3' },
  { id:'clac',     title:'J‚Äôen ai ma clac',    price:500, src:'camidjo_ma_clac.mp3' },
  { id:'poussiere',title:'Poussi√®re',          price:300, src:'camidjo_poussiere.mp3' }
];

/* ============== CONFIG NOTES / SPAWN AUDIO ============== */
const BASE_SPAWN_MS = [900, 1500];
const MAX_NOTES_ON_SCREEN = 14;
const NOTE_LIFETIME = [9000, 13000];

/* =================== √âTAT & R√âFS =================== */
const notesCountEl = document.getElementById('notesCount');
const zoneNotes = document.getElementById('zoneNotes');
const resetBtn = document.getElementById('resetNotes');
const shopEl = document.getElementById('shop');

let balance = parseInt(localStorage.getItem(STORAGE_NOTES) || '0', 10);
let owned = new Set(JSON.parse(localStorage.getItem(STORAGE_OWNED) || '[]'));

/* ====== Bulle magique (remplace alert) ====== */
function showMagicAlert(message){
  const old = document.querySelector('.magic-alert'); if (old) old.remove();
  const div = document.createElement('div');
  div.className = 'magic-alert';
  div.innerHTML = `<p>${message}</p><button>OK</button>`;
  document.body.appendChild(div);
  requestAnimationFrame(()=> div.classList.add('show'));
  div.querySelector('button').addEventListener('click', ()=>{
    div.classList.remove('show'); setTimeout(()=>div.remove(), 350);
  });
}

/* =================== RENDER BOUTIQUE =================== */
function renderShop(){
  shopEl.innerHTML = '';
  TRACKS.forEach(t=>{
    const card = document.createElement('article');
    card.className = 'card';
    const isOwned = owned.has(t.id);

    card.innerHTML = `
      <h3>${t.title}</h3>
      <div class="card-content">
        ${isOwned
          ? `<p class="owned">‚úì Achet√©e ‚Äî bonne √©coute !</p>
             <audio controls crossorigin="anonymous" src="${t.src}"></audio>`
          : `<p>Prix : <span class="price">${t.price} ‚úß</span></p>
             <button class="btn btn-buy" data-buy="${t.id}">Acheter</button>
             <p class="hint">Astuce : fais jouer une chanson pour faire appara√Ætre des notes √† r√©colter.</p>`
        }
      </div>
    `;
    shopEl.appendChild(card);
  });

  shopEl.querySelectorAll('[data-buy]').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const id = btn.getAttribute('data-buy');
      const track = TRACKS.find(x=>x.id===id);
      if (!track) return;
      attemptPurchase(track);
    });
  });

  // (Re)branche l‚Äôanalyse sur tout nouveau lecteur
  document.querySelectorAll('audio').forEach(wireAudio);
}

/* =================== ACHAT =================== */
function attemptPurchase(track){
  if (owned.has(track.id)) return;
  if (balance < track.price){
    const manque = track.price - balance;
    showMagicAlert(`Il te manque <strong>${manque} ‚úß</strong> pour acheter <em>¬´ ${track.title} ¬ª</em>.<br><br>‚ú® Continue √† jouer une chanson pour r√©colter des notes dor√©es !`);
    return;
  }
  const ok = confirm(`Acheter ¬´ ${track.title} ¬ª pour ${track.price} ‚úß ?`);
  if (!ok) return;

  balance -= track.price;
  owned.add(track.id);
  persist();
  updateBalanceUI();
  renderShop();
}

/* =================== PERSISTANCE =================== */
function persist(){
  localStorage.setItem(STORAGE_NOTES, String(balance));
  localStorage.setItem(STORAGE_OWNED, JSON.stringify([...owned]));
}
function updateBalanceUI(){ notesCountEl.textContent = balance; }

/* =================== RESET =================== */
resetBtn.addEventListener('click', ()=>{
  if (!confirm('R√©initialiser le solde ET les achats ?')) return;
  balance = 0; owned = new Set();
  persist(); updateBalanceUI(); renderShop();
});

/* =================== NOTES (SPAWN & COLLECT) =================== */
function spawnNote(){
  const n = document.createElement('button');
  n.type='button'; n.className='note'; n.setAttribute('aria-label','Ramasser une note');

  const leftPct   = rand(2,98);
  const bottomPct = rand(0,90);
  const duration  = rand(NOTE_LIFETIME[0], NOTE_LIFETIME[1]);

  n.style.left = leftPct + '%';
  n.style.bottom = bottomPct + '%';
  n.style.setProperty('--duree', duration + 'ms');
  n.innerHTML = noteSVG(['quarter','eighth','beamed'][rand(0,2)]);

  let grabbed = false;
  const collect = ()=>{
    if (grabbed) return;
    grabbed = true;
    n.classList.add('collected');
    balance += 1;   // 1 note = 1 ‚úß
    persist(); updateBalanceUI();
    setTimeout(()=> n.remove(), 320);
  };
  n.addEventListener('click', collect, {passive:true});
  n.addEventListener('touchend', collect, {passive:true});

  const killer = setTimeout(()=>{ if (n && !grabbed) n.remove(); }, duration + 300);
  n.addEventListener('remove', ()=> clearTimeout(killer));

  zoneNotes.appendChild(n);
}

/* =================== AUDIO & BOOST REFRAIN =================== */
let audioCtx=null, analyser=null, sourceNode=null, freqData=null, energyEMA=0;
let activeAudio=null, spawnTimer=null, rafId=null;

function wireAudio(a){
  if (!a || a.__wired) return;
  a.__wired = true;
  if (!a.crossOrigin) a.crossOrigin='anonymous';

  a.addEventListener('play', async ()=>{
    try{ await audioCtx?.resume(); }catch(e){}
    if (activeAudio && activeAudio!==a && !activeAudio.paused) activeAudio.pause();
    activeAudio = a;
    await attachAnalyserTo(a);
    scheduleSpawnByEnergy();
  });

  ['pause','ended'].forEach(ev=>{
    a.addEventListener(ev, ()=>{
      if (activeAudio===a){ clearTimeout(spawnTimer); spawnTimer=null; }
    });
  });

  a.addEventListener('timeupdate', ()=>{
    if (activeAudio===a && !a.paused && !a.ended) scheduleSpawnByEnergy();
  });
}

async function attachAnalyserTo(audioEl){
  if (!audioCtx) audioCtx = new (window.AudioContext||window.webkitAudioContext)();
  if (!audioEl.crossOrigin) audioEl.crossOrigin = 'anonymous';

  if (sourceNode) try{ sourceNode.disconnect(); }catch(e){}
  if (analyser)   try{ analyser.disconnect();   }catch(e){}

  analyser = audioCtx.createAnalyser();
  analyser.fftSize = 2048;
  analyser.smoothingTimeConstant = 0.75;

  sourceNode = audioCtx.createMediaElementSource(audioEl);
  sourceNode.connect(analyser);
  analyser.connect(audioCtx.destination);

  freqData = new Uint8Array(analyser.frequencyBinCount);
  energyEMA = 0;

  cancelAnimationFrame(rafId);
  const analyze = ()=>{
    if (!analyser) return;
    analyser.getByteFrequencyData(freqData);

    const lowEnd  = bandEnergy(freqData, 0.02, 0.18); // ~20‚Äì180 Hz
    const midBand = bandEnergy(freqData, 0.18, 0.45); // ~180‚Äì4.5 kHz
    let energy    = (lowEnd * 0.6) + (midBand * 0.4);
    energy = Math.min(1.2, energy);

    const alpha = 0.18;
    energyEMA = energyEMA===0 ? energy : (alpha*energy + (1-alpha)*energyEMA);

    scheduleSpawnByEnergy();
    rafId = requestAnimationFrame(analyze);
  };
  rafId = requestAnimationFrame(analyze);
}

function bandEnergy(arr, fracStart, fracEnd){
  const n = arr.length;
  const i0 = Math.max(0, Math.floor(n*fracStart));
  const i1 = Math.min(n-1, Math.floor(n*fracEnd));
  let sum=0, count=0;
  for (let i=i0;i<=i1;i++){ sum+=arr[i]; count++; }
  return count ? (sum/count)/255 : 0;
}

function scheduleSpawnByEnergy(){
  if (spawnTimer || !activeAudio || activeAudio.paused || activeAudio.ended) return;

  // √©nergie haute -> d√©lai court => plus de notes
  const chorusBoost = map(energyEMA, 0.1, 0.9, 1.15, 0.45, true);
  const vol = (typeof activeAudio.volume==='number') ? activeAudio.volume : 1;
  const volBoost = map(vol, 0.0, 1.0, 1.15, 0.85, true);

  const factor = Math.max(0.35, Math.min(2.0, chorusBoost * volBoost));
  const delay = rand(BASE_SPAWN_MS[0]*factor,BASE_SPAWN_MS[1]*factor);

  spawnTimer = setTimeout(()=>{
    spawnTimer=null;
    if (activeAudio && !activeAudio.paused && !activeAudio.ended){
      if (zoneNotes.querySelectorAll('.note:not(.collected)').length < MAX_NOTES_ON_SCREEN){
        spawnNote();
      }
      scheduleSpawnByEnergy();
    }
  }, delay);
}

/* =================== HELPERS =================== */
function rand(min,max){ return Math.floor(Math.random()*(max-min+1))+min; }
function map(x,inMin,inMax,outMin,outMax,clamp=false){
  let t = (x - inMin) / (inMax - inMin);
  if (clamp) t = Math.max(0, Math.min(1, t));
  return outMin + (outMax - outMin) * t;
}
function noteSVG(kind='quarter'){
  const pathQuarter='M14 2c3.2 0 5.8 2.6 5.8 5.8v13.2c0 3.8-3.8 6.8-8 6.8s-7.2-2.2-7.2-5 3.2-5 7.2-5c2.2 0 4.2.6 5.6 1.6V7.8c0-1.6-1.2-2.8-2.8-2.8H14z';
  const pathEighth='M9 7v14.5c-1.2-.6-2.6-.9-4-.9-3.6 0-6.5 1.8-6.5 4s2.9 4 6.5 4 6.5-1.8 6.5-4V9.5l10 3.5V5l-12-4v6z';
  const pathBeamed='M2 20c0 2.2 3.1 4 7 4s7-1.8 7-4-3.1-4-7-4-7 1.8-7 4zm10-15v11c1.1-.6 2.8-1 4.5-1 3.6 0 6.5 1.8 6.5 4s-2.9 4-6.5 4-6.5-1.8-6.5-4V5l10-3v5l-8 3V5z';
  const path = kind==='eighth'?pathEighth:kind==='beamed'?pathBeamed:pathQuarter;
  const id='gold-'+Math.random().toString(36).slice(2);
  return `
    <svg viewBox="0 0 28 30" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img">
      <defs>
        <linearGradient id="${id}" x1="0" x2="1" y1="0" y2="1">
          <stop offset="0%" stop-color="#ffef9f"/>
          <stop offset="55%" stop-color="#ffd76a"/>
          <stop offset="100%" stop-color="#ffb84d"/>
        </linearGradient>
      </defs>
      <path d="${path}" fill="url(#${id})" stroke="rgba(0,0,0,.25)" stroke-width=".4"/>
    </svg>`;
}

/* =================== INIT =================== */
updateBalanceUI();
renderShop();
document.querySelectorAll('audio').forEach(wireAudio);
</script>
</body>
</html>
