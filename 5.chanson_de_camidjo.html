<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<meta name="robots" content="noindex"/>
<title>Camidjo — Chansons & Magasin</title>

<!-- Police élégante -->
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@400;700&display=swap" rel="stylesheet">


<style>
  /* ===== Fond & base ===== */
  body{
    background:url("fond_artistes.png") center/cover fixed no-repeat;
    color:#fff8e6; font-family:Georgia,serif; text-align:center;
    margin:0; padding:2rem; min-height:100vh; box-sizing:border-box;
    position:relative;
  }
  body::before{
    content:""; position:fixed; inset:0; pointer-events:none;
    background:
      radial-gradient(120% 120% at 50% -10%, rgba(0,0,0,.10) 0%, rgba(0,0,0,.32) 70%, rgba(0,0,0,.42) 100%),
      radial-gradient(120% 120% at 50% 120%, rgba(0,0,0,.08) 0%, rgba(0,0,0,.26) 70%, rgba(0,0,0,.36) 100%);
    z-index:0;
  }
  body.no-scroll{ overflow:hidden; }

/* ====== Titre style Aurélyne ====== */
.titre-aurelyne{
  margin:0 auto .8rem; text-align:center;
  font-family:'Cinzel Decorative',serif;
  font-size:clamp(1.6rem,4vw,2.2rem);
  font-weight:700; color:#ffe79a;
  text-shadow:0 0 6px rgba(255,231,154,.5),0 0 14px rgba(255,231,154,.35);
  letter-spacing:.5px; position:relative;
}
.titre-aurelyne::after{
  content:""; display:block; width:120px; max-width:38vw; height:2px;
  margin:.5rem auto 0; border-radius:2px;
  background:linear-gradient(90deg,transparent,#ffe79a,transparent);
  opacity:.7;
}

/* ====== Cartouche élégant identique ====== */
.phrase-intro.cartouche-b{
  max-width:860px; margin:.6rem auto 1.2rem; padding:1.1rem 1.4rem;
  border-radius:16px; background:rgba(0,0,0,.5);
  border:1px solid rgba(255,231,154,.28);
  box-shadow:0 10px 28px rgba(0,0,0,.28);
  font-size:clamp(1rem,1.7vw,1.2rem); line-height:1.65;
  color:#fff8e6; text-align:center; position:relative; overflow:hidden;
}
.phrase-intro.cartouche-b::after{
  content:""; position:absolute; inset:0; pointer-events:none;
  background:
    radial-gradient(80% 100% at 50% 30%, rgba(255,247,220,.06) 0%, rgba(255,247,220,0) 60%),
    radial-gradient(120% 120% at 50% 100%, rgba(0,0,0,.18) 0%, rgba(0,0,0,0) 60%);
}
.mot-lueur{
  color:#ffe79a;
  text-shadow:0 0 8px rgba(255,231,154,.8),0 0 20px rgba(255,231,154,.6),0 0 36px rgba(255,231,154,.4);
  font-weight:600;
}


  /* ===== Titre de section (ex-« h1 ») ===== */
  .section-title{
    font-family:'Playfair Display',serif;
    color:#fce9b0; font-weight:600; margin:2rem 0 1rem;
    font-size:clamp(1.4rem,3.6vw,1.9rem);
    text-shadow:0 0 8px rgba(252,233,176,.45), 0 0 18px rgba(252,233,176,.25);
  }
  .section-title::after{
    content:""; display:block; width:120px; height:2px; margin:.45rem auto 0;
    border-radius:2px; background:linear-gradient(90deg,transparent,#f3e1b3,transparent); opacity:.75;
  }

  /* ===== Cartouche principal (verre fumé doré) ===== */
  .bloc-contenu{
    max-width:860px; margin:auto; padding:1.6rem 1.6rem;
    background:linear-gradient(180deg, rgba(0,0,0,.46), rgba(0,0,0,.36));
    border:1px solid rgba(243,225,179,.28);
    border-radius:14px;
    box-shadow:0 18px 50px rgba(0,0,0,.35), inset 0 0 0 1px rgba(255,247,220,.06);
    backdrop-filter: blur(4px);
    position:relative; z-index:1;
  }

  /* ===== Illustration encadrée ===== */
  .Artistes-image{
    width:100%; max-width:820px; border-radius:16px; display:block; margin:2rem auto 1.6rem;
    box-shadow: 0 16px 45px rgba(0,0,0,.38);
    border:1px solid rgba(243,225,179,.3);
    outline: 1px solid rgba(255,255,255,.05);
    outline-offset: -6px;
  }

  /* ===== Cartes chansons & boutique ===== */
  .chanson,.card{
    margin:1.2rem auto; max-width:860px; text-align:left;
    background:linear-gradient(180deg, rgba(0,0,0,.42), rgba(0,0,0,.32));
    border:1px solid rgba(243,225,179,.25);
    padding:1rem 1.1rem; border-radius:14px; backdrop-filter: blur(4px);
    box-shadow:0 12px 28px rgba(0,0,0,.28), inset 0 0 0 1px rgba(255,247,220,.05);
  }
  .chanson p{ margin:.2rem 0 .5rem; font-family:'Playfair Display',serif; font-weight:600; color:#fce9b0; }
  .card h3{ margin:.2rem 0 .6rem; color:#fce9b0; font-family:'Playfair Display',serif; font-weight:600; }
  .owned{ color:#9fe29f; font-weight:600; }
  .hint{ opacity:.9; font-size:.95rem; margin:.4rem 0 0; }

  audio{ width:100%; margin-top:.4rem; filter:drop-shadow(0 8px 18px rgba(0,0,0,.28)); border-radius:8px; }

  /* ===== En-tête notes ===== */
  .header-notes{ max-width:1000px; margin:1.6rem auto; display:flex; flex-direction:column; gap:1rem; align-items:center; }
  .note-info{
    font-family:'Playfair Display',serif; font-size:1.15rem; color:#fce9b0; font-weight:500;
    text-shadow:0 0 6px rgba(252,233,176,.35), 0 0 12px rgba(252,233,176,.2);
    animation: glowSoft 4.2s ease-in-out infinite alternate;
  }
  .note-info small{ display:block; margin-top:.25rem; font-weight:400; font-size:1rem; color:#fff8e6; opacity:.9; }
  @keyframes glowSoft{
    from{ text-shadow:0 0 6px rgba(252,233,176,.28), 0 0 14px rgba(252,233,176,.18); transform:translateY(0); }
    to  { text-shadow:0 0 10px rgba(252,233,176,.5), 0 0 22px rgba(252,233,176,.3); transform:translateY(-1px); }
  }

  .wallet{ display:flex; gap:.6rem; align-items:center; flex-wrap:wrap; }
  .badge-notes{
    display:inline-flex; align-items:center; gap:.5rem;
    padding:.45rem .85rem; border-radius:999px;
    background: linear-gradient(120deg,#ffefc0,#ffe499,#ffd475);
    color:#3b2d16; border:1px solid rgba(0,0,0,.18);
    box-shadow: 0 6px 18px rgba(0,0,0,.25), inset 0 1px 0 #fff8;
    font-variant-numeric: tabular-nums;
  }

  /* ===== Boutons ===== */
  .btn-row{ display:flex; flex-wrap:wrap; justify-content:center; gap:1rem; margin:1.2rem auto 1.6rem; }
  .btn{ appearance:none; border:none; cursor:pointer; padding:.6rem 1rem; border-radius:12px; font-weight:600; letter-spacing:.2px; transition: transform .18s ease, filter .2s ease, box-shadow .2s ease; }
  .btn-ghost{
    background:transparent; color:#fce9b0; border:1px solid rgba(243,225,179,.45);
    box-shadow:0 6px 16px rgba(0,0,0,.18);
  }
  .btn-ghost:hover{ background:rgba(255,243,207,.09); filter:brightness(1.05); transform:translateY(-1px); }
  .btn-buy{
    background:linear-gradient(180deg, #b79b57 0%, #d8c179 100%);
    color:#2b2212; box-shadow:0 8px 22px rgba(0,0,0,.28), inset 0 0 14px rgba(255,231,154,.2);
    text-shadow:0 0 4px rgba(255,255,255,.35);
  }
  .btn-buy:hover{ filter:brightness(1.1); transform:translateY(-1px); }
  .btn-buy[disabled]{ opacity:.6; cursor:not-allowed; filter:none; transform:none; }
  .price{ color:#fce9b0; font-weight:700; }

  /* ===== Grille boutique ===== */
  .shop{ max-width:1000px; margin:1.2rem auto; display:grid; gap:1rem; grid-template-columns:1fr; }
  @media(min-width:900px){ .shop{ grid-template-columns:1fr 1fr; } }

  /* ===== Overlay notes ===== */
  .zone-notes{ position:fixed; inset:0; width:100%; height:100%; z-index:30; pointer-events:none; overflow:hidden; }
  .note{ position:absolute; pointer-events:auto; width:clamp(26px,3.5vw,40px); aspect-ratio:1/1; cursor:pointer; transform-origin:center; animation:flotter var(--duree,10s) linear forwards, wiggle 2.4s ease-in-out infinite; filter:drop-shadow(0 6px 10px rgba(0,0,0,.45)); background:none; border:none; padding:0; }
  .note svg{ width:100%; height:100%; display:block; }
  .note.collected{ animation:pop .35s ease forwards; }
  @keyframes flotter{ from{ transform:translateY(0) rotate(-8deg); opacity:0; } 10%{opacity:1;} to{ transform:translateY(-120vh) rotate(8deg); opacity:0; } }
  @keyframes wiggle{ 0%,100%{ transform:translateY(0) rotate(-2deg);} 50%{ transform:translateY(-6px) rotate(2deg);} }
  @keyframes pop{ 0%{transform:scale(1);opacity:1;} 70%{transform:scale(1.6);opacity:1;filter:drop-shadow(0 12px 24px rgba(0,0,0,.5));} 100%{transform:scale(.6);opacity:0;} }

  /* ===== Bulle magique ===== */
  .magic-alert {
    position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0.96);
    background: rgba(20, 10, 0, 0.86); color: #ffeb9b;
    border: 1px solid rgba(255, 215, 100, 0.55); border-radius: 16px;
    box-shadow: 0 12px 40px rgba(0,0,0,.4), 0 0 25px rgba(255, 215, 100, 0.18);
    padding: 1.15rem 1.4rem; max-width: 320px; width: 86%;
    text-align: center; font-size: 1.05rem; line-height: 1.6; z-index: 10001;
    opacity: 0; transition: all 0.35s ease;
  }
  .magic-alert.show { opacity: 1; transform: translate(-50%, -50%) scale(1); }
  .magic-alert::before { content: "✨"; display: block; font-size: 1.6rem; margin-bottom: .4rem; }
  .magic-alert button { margin-top: 1rem; background: #ffd76a; color: #3b2d16; border: none; border-radius: 10px; padding: .4rem 1rem; cursor: pointer; font-weight: 600; box-shadow: 0 0 8px rgba(255,215,100,.35); }
  .magic-alert button:hover { background: #ffef9f; }

  /* ===== Modal achat ===== */
  .modal-backdrop{ position:fixed; inset:0; background:rgba(0,0,0,.45); opacity:0; transition:opacity .25s ease; z-index:10000; pointer-events:none; }
  .modal{
    position:fixed; top:50%; left:50%; transform:translate(-50%,-50%) scale(.95);
    background:rgba(20,10,0,.9); border:1px solid rgba(255,215,100,.55);
    color:#ffeb9b; border-radius:16px; box-shadow:0 18px 50px rgba(0,0,0,.45);
    padding:1.1rem 1.3rem; max-width:360px; width:86%; text-align:center;
    z-index:10001; opacity:0; transition:all .25s ease;
  }
  .modal.show{ opacity:1; transform:translate(-50%,-50%) scale(1); }
  .modal-backdrop.show{ opacity:1; pointer-events:auto; }
  .modal h4{ margin:.2rem 0 .8rem; color:#fce9b0; font-size:1.1rem; font-family:'Playfair Display',serif; }
  .modal p{ margin:0 0 .8rem; }
  .modal .actions{ display:flex; gap:.6rem; justify-content:center; margin-top:.4rem; }
  .modal .btn-yes{ background:#9fe29f; color:#143a14; }
  .modal .btn-no{ background:transparent; color:#fce9b0; border:1px solid rgba(243,225,179,.5); }
  .modal button{ padding:.5rem 1rem; border-radius:10px; border:none; cursor:pointer; font-weight:700; }

  /* ===== Mobile ===== */
  @media (max-width: 480px){
    body{ padding: 1.2rem; }
    .titre-camidjo{ font-size: clamp(1.4rem, 6.4vw, 1.7rem); margin-bottom:.8rem; }
    .bloc-contenu{ max-width: 100%; padding: 1.05rem .95rem; border-radius: 14px; }
    .bloc-contenu p { font-size: 1rem; line-height: 1.55; }
    .chanson{ max-width: 100%; padding: .85rem; margin: 1rem auto; border-radius: 12px; }
    .Artistes-image{ margin: 1.2rem auto; border-radius: 14px; }
    audio{ margin-top: .35rem; }
    .note-info{ font-size: 1rem; animation-duration: 4.6s; }
    .badge-notes{ padding: .35rem .7rem; transform: scale(.97); }
    .shop{ grid-template-columns: 1fr !important; gap: .9rem; }
    .card{ max-width: 100%; padding: .9rem; border-radius: 13px; }
  }
  @media (max-width: 768px){
    .section-title{ font-size:1.6rem; }
    .bloc-contenu p{ font-size: 1.05rem; }
  }
</style>
</head>

<body>
  <!-- Titre hors cadre -->
  <h1 class="titre-aurelyne">Camidjo</h1>
  
  <!-- Cartouche d’intro (sans “Le Créateur”) -->
 <div class="phrase-intro cartouche-b">
  <p><strong>Bonjour, jeune Aventurier&nbsp;!</strong><br>
  Bienvenue dans mon magasin.<br>
  Je m’appelle <span class="mot-lueur">Camidjo</span>, et je suis le créateur de ce monde.</p>

  <p>Pour la petite <strong>anecdote</strong>, j’étais en train de composer
  <em>«&nbsp;Façon de faire&nbsp;»</em> lorsque j’ai entendu
  <span class="mot-lueur">l’Appel d’Arzankia</span>.<br>
  C’est en fredonnant cette chanson que <strong>mon monde est né</strong>.</p>

  <p>✨<strong>Récolte les notes dorées</strong> pour débloquer mes mélodies…✨</p>

  <p><strong>Ouvre grand tes oreilles, et laisse la magie opérer.</strong></p>
</div>

  <img class="Artistes-image" src="monde_Artiste.png" alt="Illustration du Monde des Artistes">

  <h2 class="section-title">Chansons de Camidjo</h2>

  <!-- Piste gratuite -->
  <div class="chanson">
    <p>🎶 Pensée pour elle <span class="hint">(gratuite)</span></p>
    <audio controls crossorigin="anonymous" src="camidjo_pensee.mp3"></audio>
  </div>

  <!-- Solde + message -->
  <div class="header-notes" aria-live="polite">
    <div class="note-info">
      <small>Achète les chansons avec tes notes récoltées dans la page.</small>
    </div>
    <div class="wallet">
      <span class="badge-notes">Solde : <strong id="notesCount">0</strong> ✧</span>
      <button id="resetNotes" class="btn btn-ghost" type="button">Réinitialiser le solde & achats</button>
    </div>
  </div>

  <!-- Overlay des notes -->
  <div id="zoneNotes" class="zone-notes" aria-label="Zone de collecte des notes"></div>

  <!-- Boutique -->
  <section class="shop" id="shop"></section>

  <div class="btn-row" style="position:relative; z-index:50;">
    <a id="btnBack" class="btn btn-ghost" href="8.monde_Artistes.html" rel="prev">← Retour</a>
  </div>

<script>
/* =================== CONFIG BOUTIQUE =================== */
const STORAGE_NOTES = 'camidjo_notes_balance';
const STORAGE_OWNED = 'camidjo_owned_tracks';

const TRACKS = [
  { id:'facon',    title:'Façon de faire',     price:150, src:'camidjo_facon_de_faire.mp3' },
  { id:'clac',     title:'J’en ai ma clac',    price:500, src:'camidjo_ma_clac.mp3' },
  { id:'poussiere',title:'Poussière',          price:300, src:'camidjo_poussiere.mp3' }
];

/* ============== CONFIG NOTES / SPAWN AUDIO ============== */
const BASE_SPAWN_MS = [900, 1500];
const MAX_NOTES_ON_SCREEN = 14;
const NOTE_LIFETIME = [9000, 13000];

/* ====== BOOST REFRAINS : timings (en secondes) ====== */
const CHORUS_WINDOWS = {
  'camidjo_pensee.mp3'         : [45, 55, 100, 110],                 // Pensée pour elle
  'camidjo_facon_de_faire.mp3' : [48, 55, 109, 115, 174],            // Façon de faire
  'camidjo_poussiere.mp3'      : [67, 75],                            // Poussière
  'camidjo_ma_clac.mp3'        : [28, 40, 50, 84, 90, 100, 138, 145, 150, 157] // J’en ai ma clac
};
const CHORUS_WINDOW_SEC = 3.5;        // demi-largeur de la fenêtre autour du point
const CHORUS_DELAY_MULTIPLIER = 0.42; // <1 = plus de notes pendant la fenêtre

const fileNameFromSrc = (src) => { try { return src.split('/').pop().split('?')[0]; } catch { return src; } };
function inChorusWindow(audioEl){
  if (!audioEl || !audioEl.src) return false;
  const key = fileNameFromSrc(audioEl.src);
  const marks = CHORUS_WINDOWS[key];
  if (!marks || !marks.length) return false;
  const t = audioEl.currentTime || 0;
  for (const m of marks){ if (Math.abs(t - m) <= CHORUS_WINDOW_SEC) return true; }
  return false;
}

/* =================== ÉTAT & RÉFS =================== */
const notesCountEl = document.getElementById('notesCount');
const zoneNotes = document.getElementById('zoneNotes');
const resetBtn = document.getElementById('resetNotes');
const shopEl = document.getElementById('shop');

let balance = parseInt(localStorage.getItem(STORAGE_NOTES) || '0', 10);
let owned = new Set(JSON.parse(localStorage.getItem(STORAGE_OWNED) || '[]'));

/* ====== Bulle magique ====== */
function showMagicAlert(message){
  const old = document.querySelector('.magic-alert'); if (old) old.remove();
  const div = document.createElement('div');
  div.className = 'magic-alert';
  div.setAttribute('role','dialog');
  div.setAttribute('aria-modal','true');
  div.innerHTML = `<p>${message}</p><button aria-label="Fermer">OK</button>`;
  document.body.appendChild(div);
  requestAnimationFrame(()=> div.classList.add('show'));
  div.querySelector('button').addEventListener('click', ()=>{
    div.classList.remove('show'); setTimeout(()=>div.remove(), 350);
  });
}

/* ====== Modal d’achat ====== */
function showConfirmPurchase(track, onYes){
  const backdrop = document.createElement('div');
  backdrop.className = 'modal-backdrop';

  const modal = document.createElement('div');
  modal.className = 'modal';
  modal.setAttribute('role','dialog');
  modal.setAttribute('aria-modal','true');
  modal.innerHTML = `
    <h4>Confirmer l’achat</h4>
    <p>Acheter <em>« ${track.title} »</em> pour <strong>${track.price} ✧</strong> ?</p>
    <div class="actions">
      <button class="btn btn-yes" autofocus>Oui</button>
      <button class="btn btn-no">Non</button>
    </div>
  `;

  const close = () => {
    backdrop.classList.remove('show'); modal.classList.remove('show'); 
    setTimeout(()=>{ backdrop.remove(); modal.remove(); document.body.classList.remove('no-scroll'); }, 200);
    window.removeEventListener('keydown', onKey);
  };
  const onKey = (e)=>{
    if(e.key === 'Escape'){ close(); }
    if(e.key === 'Enter'){ yes(); }
  };
  const yes = ()=>{
    close();
    onYes?.();
  };

  document.body.append(backdrop, modal);
  document.body.classList.add('no-scroll');
  requestAnimationFrame(()=>{ backdrop.classList.add('show'); modal.classList.add('show'); });
  modal.querySelector('.btn-yes').addEventListener('click', yes);
  modal.querySelector('.btn-no').addEventListener('click', close);
  window.addEventListener('keydown', onKey);
  modal.querySelector('.btn-yes').focus();
}

/* =================== Boutique =================== */
function renderShop(){
  shopEl.innerHTML = '';
  TRACKS.forEach(t=>{
    const card = document.createElement('article');
    card.className = 'card';
    const isOwned = owned.has(t.id);

    card.innerHTML = `
      <h3>${t.title}</h3>
      <div class="card-content">
        ${isOwned
          ? `<p class="owned">✓ Achetée — bonne écoute !</p>
             <audio controls crossorigin="anonymous" src="${t.src}"></audio>`
          : `<p>Prix : <span class="price">${t.price} ✧</span></p>
             <button class="btn btn-buy" data-buy="${t.id}">Acheter</button>
             <p class="hint">Astuce : fais jouer une chanson pour faire apparaître des notes à récolter.</p>`
        }
      </div>
    `;
    shopEl.appendChild(card);
  });

  shopEl.querySelectorAll('[data-buy]').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const id = btn.getAttribute('data-buy');
      const track = TRACKS.find(x=>x.id===id);
      if (!track) return;
      attemptPurchase(track);
    });
  });

  document.querySelectorAll('audio').forEach(wireAudio);
}

/* =================== Achat =================== */
function attemptPurchase(track){
  if (owned.has(track.id)) return;
  if (balance < track.price){
    const manque = track.price - balance;
    showMagicAlert(`Il te manque <strong>${manque} ✧</strong> pour acheter <em>« ${track.title} »</em>.<br><br>✨ Continue à jouer une chanson pour récolter des notes dorées !`);
    return;
  }
  showConfirmPurchase(track, ()=>{
    balance -= track.price;
    owned.add(track.id);
    persist();
    updateBalanceUI();
    renderShop();
  });
}

/* =================== Persistance =================== */
function persist(){
  localStorage.setItem(STORAGE_NOTES, String(balance));
  localStorage.setItem(STORAGE_OWNED, JSON.stringify([...owned]));
}
function updateBalanceUI(){ notesCountEl.textContent = balance; }

/* =================== Reset =================== */
resetBtn.addEventListener('click', ()=>{
  showConfirmPurchase({title:'réinitialiser', price:0}, ()=>{
    balance = 0; owned = new Set();
    persist(); updateBalanceUI(); renderShop();
  });
});

/* =================== Notes (spawn & collect) =================== */
function spawnNote(){
  const n = document.createElement('button');
  n.type='button'; n.className='note'; n.setAttribute('aria-label','Ramasser une note');

  const leftPct   = rand(2,98);
  const bottomPct = rand(0,90);
  const duration  = rand(NOTE_LIFETIME[0], NOTE_LIFETIME[1]);

  n.style.left = leftPct + '%';
  n.style.bottom = bottomPct + '%';
  n.style.setProperty('--duree', duration + 'ms');
  n.innerHTML = noteSVG(['quarter','eighth','beamed'][rand(0,2)]);

  let grabbed = false;
  const collect = ()=>{
    if (grabbed) return;
    grabbed = true;
    n.classList.add('collected');
    balance += 1;
    persist(); updateBalanceUI();
    setTimeout(()=> n.remove(), 320);
  };
  n.addEventListener('click', collect, {passive:true});
  n.addEventListener('touchend', collect, {passive:true});

  const killer = setTimeout(()=>{ if (n && !grabbed) n.remove(); }, duration + 300);
  n.addEventListener('remove', ()=> clearTimeout(killer));

  zoneNotes.appendChild(n);
}

/* =================== Audio & boost refrain =================== */
let audioCtx=null, analyser=null, sourceNode=null, freqData=null, energyEMA=0;
let activeAudio=null, spawnTimer=null, rafId=null;

function wireAudio(a){
  if (!a || a.__wired) return;
  a.__wired = true;
  if (!a.crossOrigin) a.crossOrigin='anonymous';

  a.addEventListener('play', async ()=>{
    try{ await audioCtx?.resume(); }catch(e){}
    if (activeAudio && activeAudio!==a && !activeAudio.paused) activeAudio.pause();
    activeAudio = a;
    await attachAnalyserTo(a);
    scheduleSpawnByEnergy();
  });

  ['pause','ended'].forEach(ev=>{
    a.addEventListener(ev, ()=>{
      if (activeAudio===a){ clearTimeout(spawnTimer); spawnTimer=null; }
    });
  });

  a.addEventListener('timeupdate', ()=>{
    if (activeAudio===a && !a.paused && !a.ended) scheduleSpawnByEnergy();
  });
}

async function attachAnalyserTo(audioEl){
  if (!audioCtx) audioCtx = new (window.AudioContext||window.webkitAudioContext)();
  if (!audioEl.crossOrigin) audioEl.crossOrigin = 'anonymous';

  if (!audioEl.__mediaSource) {
    audioEl.__mediaSource = audioCtx.createMediaElementSource(audioEl);
  }
  sourceNode = audioEl.__mediaSource;

  if (analyser) { try{ analyser.disconnect(); }catch(e){} }
  analyser = audioCtx.createAnalyser();
  analyser.fftSize = 2048;
  analyser.smoothingTimeConstant = 0.75;

  try { sourceNode.disconnect(); } catch(e){}
  sourceNode.connect(analyser);
  analyser.connect(audioCtx.destination);

  freqData = new Uint8Array(analyser.frequencyBinCount);
  energyEMA = 0;

  cancelAnimationFrame(rafId);
  const analyze = ()=>{
    if (!analyser) return;
    analyser.getByteFrequencyData(freqData);

    const lowEnd  = bandEnergy(freqData, 0.02, 0.18);
    const midBand = bandEnergy(freqData, 0.18, 0.45);
    let energy    = (lowEnd * 0.6) + (midBand * 0.4);
    energy = Math.min(1.2, energy);

    const alpha = 0.18;
    energyEMA = energyEMA===0 ? energy : (alpha*energy + (1-alpha)*energyEMA);

    scheduleSpawnByEnergy();
    rafId = requestAnimationFrame(analyze);
  };
  rafId = requestAnimationFrame(analyze);
}

function bandEnergy(arr, fracStart, fracEnd){
  const n = arr.length;
  const i0 = Math.max(0, Math.floor(n*fracStart));
  const i1 = Math.min(n-1, Math.floor(n*fracEnd));
  let sum=0, count=0;
  for (let i=i0;i<=i1;i++){ sum+=arr[i]; count++; }
  return count ? (sum/count)/255 : 0;
}

/* === ICI : délai entre spawns, boosté pendant les refrains === */
function scheduleSpawnByEnergy(){
  if (spawnTimer || !activeAudio || activeAudio.paused || activeAudio.ended) return;

  const chorusBoost = map(energyEMA, 0.1, 0.9, 1.15, 0.45, true);
  const vol = (typeof activeAudio.volume==='number') ? activeAudio.volume : 1;
  const volBoost = map(vol, 0.0, 1.0, 1.15, 0.85, true);
  let factor = Math.max(0.35, Math.min(2.0, chorusBoost * volBoost));

  // BOOST refrains : réduis le délai => plus de notes
  if (inChorusWindow(activeAudio)) {
    factor *= CHORUS_DELAY_MULTIPLIER;
  }

  const delay = rand(BASE_SPAWN_MS[0]*factor, BASE_SPAWN_MS[1]*factor);

  spawnTimer = setTimeout(()=>{
    spawnTimer=null;
    if (activeAudio && !activeAudio.paused && !activeAudio.ended){
      if (zoneNotes.querySelectorAll('.note:not(.collected)').length < MAX_NOTES_ON_SCREEN){
        spawnNote();
      }
      scheduleSpawnByEnergy();
    }
  }, delay);
}

/* =================== Helpers =================== */
function rand(min,max){ return Math.floor(Math.random()*(max-min+1))+min; }
function map(x,inMin,inMax,outMin,outMax,clamp=false){
  let t = (x - inMin) / (inMax - inMin);
  if (clamp) t = Math.max(0, Math.min(1, t));
  return outMin + (outMax - outMin) * t;
}
function noteSVG(kind='quarter'){
  const pathQuarter='M14 2c3.2 0 5.8 2.6 5.8 5.8v13.2c0 3.8-3.8 6.8-8 6.8s-7.2-2.2-7.2-5 3.2-5 7.2-5c2.2 0 4.2.6 5.6 1.6V7.8c0-1.6-1.2-2.8-2.8-2.8H14z';
  const pathEighth='M9 7v14.5c-1.2-.6-2.6-.9-4-.9-3.6 0-6.5 1.8-6.5 4s2.9 4 6.5 4 6.5-1.8 6.5-4V9.5l10 3.5V5l-12-4v6z';
  const pathBeamed='M2 20c0 2.2 3.1 4 7 4s7-1.8 7-4-3.1-4-7-4-7 1.8-7 4zm10-15v11c1.1-.6 2.8-1 4.5-1 3.6 0 6.5 1.8 6.5 4s-2.9 4-6.5 4-6.5-1.8-6.5-4V5l10-3v5l-8 3V5z';
  const path = kind==='eighth'?pathEighth:kind==='beamed'?pathBeamed:pathQuarter;
  const id='gold-'+Math.random().toString(36).slice(2);
  return `
    <svg viewBox="0 0 28 30" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img">
      <defs>
        <linearGradient id="${id}" x1="0" x2="1" y1="0" y2="1">
          <stop offset="0%" stop-color="#ffef9f"/>
          <stop offset="55%" stop-color="#ffd76a"/>
          <stop offset="100%" stop-color="#ffb84d"/>
        </linearGradient>
      </defs>
      <path d="${path}" fill="url(#${id})" stroke="rgba(0,0,0,.25)" stroke-width=".4"/>
    </svg>`;
}

/* =================== INIT =================== */
updateBalanceUI();
renderShop();
document.querySelectorAll('audio').forEach(wireAudio);

/* Retour soft */
document.getElementById('btnBack').addEventListener('click', function (e) {
  if (window.history.length > 1) { e.preventDefault(); window.history.back(); }
});
</script>

</body>
</html>
